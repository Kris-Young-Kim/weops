# WeOps 데이터베이스 관리 원칙 및 유지보수 가이드

**문서 버전**: 1.0  
**최종 수정일**: 2025-01-21  
**적용 범위**: WeOps 데이터베이스 전체  
**참고 문서**: 
- [데이터베이스 관리 원칙](./database-maintenance-guide.md)
- [데이터베이스 정규화 가이드](./database-normalization-guide.md)
- [비개발자 데이터 관리 가이드](./비개발자-데이터관리-가이드.md)

---

## 📋 목차

1. [절대 수정 금지 테이블 리스트](#1-절대-수정-금지-테이블-리스트)
2. [제한적 수정 가능 테이블](#2-제한적-수정-가능-테이블)
3. [핵심 원칙](#3-핵심-원칙)
4. [테이블별 상세 설명](#4-테이블별-상세-설명)
5. [안전한 데이터 수정 방법](#5-안전한-데이터-수정-방법)
6. [운영자 체크리스트](#6-운영자-체크리스트)
7. [비상 상황 대응](#7-비상-상황-대응)

---

## 1. 절대 수정 금지 테이블 리스트

아래 목록은 **Neon Console (SQL Editor)에서 직접 INSERT/UPDATE/DELETE를 수행하면 안 되는 테이블**입니다.

이 테이블들은 데이터 무결성, 정산, 추적, 보안의 핵심이므로, 잘못 수정하면 시스템 전체가 영향을 받습니다.

### A. 절대 수정 금지 테이블

| 테이블명 | 왜 절대 금지인가 | 특히 건드리면 바로 사고 나는 필드 |
|---------|----------------|-------------------------------|
| `users` | 인증/권한의 기준. 잘못 수정하면 계정 연결/권한 모두 깨짐 | `id`, `clerk_user_id`, `email`, `role`, `org_id` |
| `organizations` | 멀티테넌시의 최상위 엔티티. 수정하면 모든 하위 데이터 연결 끊김 | `id`, `name` |
| `recipients` | 수급자 정보 원장. 한도/정산의 기준. 수정하면 정산 오류 | `id`, `org_id`, `ltc_number`, `limit_balance` |
| `orders` | 주문 원장(정산/청구의 근거). 수정하면 정산 데이터 불일치 | `id`, `org_id`, `recipient_id`, `total_amount`, `copay_amount`, `claim_amount` |
| `order_items` | 주문 상세 원장. 수정하면 주문-자산 연결 끊김 | `id`, `order_id`, `asset_id`, `product_id`, `price` |
| `assets` | 자산 원장(재고/대여 추적). 수정하면 재고 관리 불가 | `id`, `org_id`, `qr_code`, `status`, `current_recipient_id` |

### B. 왜 위험한가?

#### 데이터 무결성 파괴
- 외래키 관계가 깨져서 조회 오류 발생
- 정산 데이터가 맞지 않아 재무 문제 발생
- 재고 관리 시스템이 작동하지 않음

#### 추적 불가능
- 로그/원장 데이터가 수정되면 감사(audit) 불가
- 분쟁 발생 시 증거 자료로 사용 불가
- 법적 문제 발생 시 대응 불가

#### 보안 취약
- `users` 테이블의 `role`을 잘못 수정하면 권한 우회 가능
- `clerk_user_id`를 수정하면 인증 시스템과 불일치 발생
- `org_id`를 수정하면 멀티테넌시 격리 파괴

---

## 2. 제한적 수정 가능 테이블

아래 테이블은 운영자가 다루는 경우가 많아 **"제한적 허용"**으로 분류합니다.

### 2.1 products (제품 마스터)

**위험도**: 🟡 중간 (제한적 수정 가능)

**허용되는 필드 (필요 시 수정 가능)**:
- ✅ `name`: 제품명
- ✅ `price`: 공단 고시가
- ✅ `category`: 품목명
- ✅ `durability_years`: 내구연한

**절대 금지 필드**:
- ❌ `id`: 제품 고유 식별자 (연결 무결성에 영향)
- ❌ `code`: 복지용구 코드 (연결 무결성에 영향)

**주의사항**:
- ❌ 대량 일괄 수정 금지 (마이그레이션 스크립트 사용)
- ✅ 개별 제품 수정은 허용 (단, PK/FK 필드는 제외)
- ✅ 가격 변경 시 기존 주문에 영향 없음 (스냅샷 방식)

**안전한 수정 예시**:
```sql
-- ✅ 허용: 개별 제품 정보 수정
UPDATE products
SET name = '새로운 제품명',
    price = 500000,
    category = '전동침대'
WHERE id = '제품UUID';

-- ❌ 금지: 대량 일괄 수정
UPDATE products SET price = price * 1.1;  -- 마이그레이션 스크립트로 처리해야 함

-- ❌ 금지: PK/코드 수정
UPDATE products SET id = '새ID';  -- 절대 금지
UPDATE products SET code = '새코드';  -- 연결 무결성 파괴
```

---

## 3. 핵심 원칙

### 3.1 절대 수정 금지 원칙

**다음 4가지 카테고리의 테이블은 운영자가 Neon Console에서 직접 수정하면 안 됩니다:**

1. **돈 (주문/정산)**
   - `orders`
   - `order_items`

2. **시간 (주문/자산 이력)**
   - `orders`
   - `assets` (상태 변경 이력)

3. **근거 (원장/로그)**
   - `recipients` (한도 관리 원장)
   - `assets` (자산 추적 원장)

4. **권한 (users/role)**
   - `users` (특히 `id`, `clerk_user_id`, `email`, `role`, `org_id`)
   - `organizations` (멀티테넌시 기준)

### 3.2 정규화 원칙

**핵심 원칙**: 배열 데이터(JSONB, ARRAY)는 사용하지 않고, 별도 테이블을 만들어 1:N 관계로 관리합니다.

**현재 스키마 상태**:
- ✅ 배열 데이터 없음 (정규화 완료)
- ✅ 모든 관계가 FK로 명시적 관리
- ✅ 중복 데이터 최소화

---

## 4. 테이블별 상세 설명

### 4.1 users 테이블

**위험도**: 🔴 최고

**절대 수정 금지 필드**:
- `id`: 사용자 고유 식별자. 변경 시 모든 관련 데이터와의 연결이 끊김
- `clerk_user_id`: Clerk 인증 시스템과의 연결. 변경 시 로그인 불가
- `email`: 인증 및 통신의 기준. 변경 시 계정 복구 불가
- `role`: 권한 관리의 기준. 변경 시 보안 취약 발생
- `org_id`: 멀티테넌시 격리의 기준. 변경 시 데이터 격리 파괴

**허용되는 작업**:
- ✅ 읽기 전용 조회 (SELECT)
- ✅ 애플리케이션을 통한 프로필 정보 수정 (이름, 프로필 이미지 등)

**금지되는 작업**:
- ❌ 대시보드에서 직접 `id`, `clerk_user_id`, `email`, `role`, `org_id` 수정
- ❌ 대시보드에서 직접 행 삭제

### 4.2 organizations 테이블

**위험도**: 🔴 최고

**절대 수정 금지 필드**:
- `id`: 사업소 고유 식별자. 변경 시 모든 하위 데이터 연결 끊김
- `name`: 사업소명 (멀티테넌시 식별 기준)

**연결된 테이블**:
- `users` (org_id)
- `recipients` (org_id)
- `assets` (org_id)
- `orders` (org_id)

**허용되는 작업**:
- ✅ 읽기 전용 조회 (SELECT)
- ✅ 애플리케이션을 통한 사업소명 수정 (단, `id`는 절대 변경 금지)

**금지되는 작업**:
- ❌ 대시보드에서 직접 `id` 수정
- ❌ 대시보드에서 직접 행 삭제

### 4.3 recipients 테이블

**위험도**: 🔴 최고

**절대 수정 금지 필드**:
- `id`: 수급자 고유 식별자
- `org_id`: 사업소 연결
- `ltc_number`: 장기요양인정번호 (정산 기준)
- `limit_balance`: 연간 한도 잔액 (정산 기준)

**위험성**:
- 정산의 원장(ledger)
- 수정 시 한도 계산 오류
- 정산 오류로 인한 재무 문제

**허용되는 작업**:
- ✅ 읽기 전용 조회 (SELECT)
- ✅ 애플리케이션을 통한 수급자 정보 수정 (이름, 만료일 등, 단 한도는 제외)

**금지되는 작업**:
- ❌ 대시보드에서 직접 `id`, `org_id`, `ltc_number`, `limit_balance` 수정
- ❌ 대시보드에서 직접 행 삭제

### 4.4 orders 테이블

**위험도**: 🔴 최고

**절대 수정 금지 필드**:
- `id`: 주문 고유 식별자
- `org_id`: 사업소 연결
- `recipient_id`: 수급자 연결
- `total_amount`: 총액
- `copay_amount`: 본인부담금
- `claim_amount`: 공단 청구액

**위험성**:
- 정산의 원장(ledger)
- 수정 시 정산 데이터 불일치
- 재무 문제 발생

**허용되는 작업**:
- ✅ 읽기 전용 조회 (SELECT)

**금지되는 작업**:
- ❌ 대시보드에서 직접 수정/삭제
- ❌ 금액 값 변경

### 4.5 assets 테이블

**위험도**: 🔴 최고

**절대 수정 금지 필드**:
- `id`: 자산 고유 식별자
- `org_id`: 사업소 연결
- `qr_code`: QR 코드 (고유 식별자)
- `status`: 자산 상태 (상태 머신)
- `current_recipient_id`: 현재 수급자 연결

**위험성**:
- 재고 관리의 원장
- 수정 시 재고 추적 불가
- 자산 상태 머신 파괴

**허용되는 작업**:
- ✅ 읽기 전용 조회 (SELECT)
- ✅ 애플리케이션을 통한 상태 변경 (예: AVAILABLE → RENTED)

**금지되는 작업**:
- ❌ 대시보드에서 직접 `id`, `org_id`, `qr_code` 수정
- ❌ 대시보드에서 직접 행 삭제
- ❌ 상태 머신 규칙을 무시한 상태 변경

---

## 5. 안전한 데이터 수정 방법

### 5.1 애플리케이션을 통한 수정

**원칙**: 모든 데이터 수정은 애플리케이션의 API를 통해 수행해야 합니다.

**이유**:
- 비즈니스 로직 검증
- 권한 검증
- 로그 기록
- 데이터 무결성 보장

**예시**:
- ✅ 수급자 정보 수정: `/api/recipients/[id]` API 사용
- ✅ 자산 상태 변경: `/api/assets/[id]/status` API 사용
- ❌ Neon Console에서 직접 `recipients` 테이블 수정

### 5.2 마이그레이션을 통한 수정

**원칙**: 대량 데이터 수정은 마이그레이션 스크립트로 수행해야 합니다.

**절차**:
1. 마이그레이션 스크립트 작성
2. 개발 환경에서 테스트
3. 코드 리뷰
4. 스테이징 환경에서 검증
5. 프로덕션 적용

**예시**:
```sql
-- ✅ 올바른 방법: 마이그레이션 스크립트
-- src/db/migrations/YYYYMMDDHHMMSS_update_product_prices.sql
UPDATE products
SET price = price * 1.1
WHERE category = '전동침대'
AND created_at >= '2025-01-01';

-- ❌ 잘못된 방법: 대시보드에서 직접 수정
```

### 5.3 읽기 전용 조회

**원칙**: 대시보드에서 데이터 조회는 허용됩니다.

**허용되는 작업**:
- ✅ SELECT 쿼리 실행
- ✅ 통계 조회
- ✅ 데이터 검증

**주의사항**:
- 개인정보가 포함된 데이터는 조회 시 주의
- 대량 조회는 성능에 영향을 줄 수 있음

---

## 6. 운영자 체크리스트

**작업 전/후 반드시 확인할 10개 항목**

### 6.1 작업 전 체크리스트

#### ✅ 1. 작업 대상이 절대 수정 금지 테이블인지 먼저 확인한다

**금지 테이블 목록**:
- `users`, `organizations`, `recipients`, `orders`, `order_items`, `assets`

**확인 방법**:
- [ ] 작업 대상 테이블이 위 목록에 있는가?
- [ ] 있다면 즉시 중단하고 개발팀에 문의

#### ✅ 2. 수정 전, 대상 row를 먼저 SELECT로 '범위' 확인한다

```sql
-- ✅ 반드시 먼저 실행: 영향받는 행 수 확인
SELECT COUNT(*) 
FROM products 
WHERE category = '전동침대'
AND price > 100000;

-- 확인 후에만 UPDATE 실행
UPDATE products 
SET price = price * 1.1
WHERE category = '전동침대'
AND price > 100000;
```

**확인 사항**:
- [ ] SELECT로 영향받는 행 수를 확인했는가?
- [ ] 예상보다 많은 행이 영향받는가? (있다면 중단)
- [ ] WHERE 조건이 정확한가?

#### ✅ 3. PK/FK는 절대 수정하지 않는다

**금지 필드**:
- `id`, `_id` (user_id, org_id, recipient_id, order_id, asset_id, product_id 등)

**확인 사항**:
- [ ] 수정하려는 필드가 PK(기본키)인가?
- [ ] 수정하려는 필드가 FK(외래키)인가?
- [ ] 하나라도 해당되면 수정 금지

#### ✅ 4. DELETE는 원칙적으로 금지

**삭제 대신 비활성화를 우선한다.**

**확인 사항**:
- [ ] DELETE를 실행하려는가?
- [ ] 로그/원장성 테이블인가?
- [ ] 있다면 개발팀에 문의

#### ✅ 5. 주문/정산 값은 '수정'이 아니라 '정정 기록(추가 row)'로 처리한다

**특히 `orders`, `order_items`는 덮어쓰기 금지.**

**올바른 방법**:
```sql
-- ✅ 올바른 방법: 정정 주문 추가 (애플리케이션 API 사용)
-- ❌ 잘못된 방법: 기존 주문 수정
UPDATE orders SET total_amount = 100000 WHERE id = '주문ID';
```

**확인 사항**:
- [ ] `orders` 또는 `order_items`를 수정하려는가?
- [ ] 수정 대신 정정 기록(새 주문)을 추가해야 하는가?

#### ✅ 6. 대시보드에서 대량 UPDATE/INSERT를 하지 않는다

**기준**:
- 10건 이하: 대시보드에서 수정 가능 (단, PK/FK 제외)
- 10건 이상: 마이그레이션 스크립트 필수

**확인 사항**:
- [ ] 영향받는 행이 10건 이상인가?
- [ ] 있다면 개발팀에 마이그레이션 스크립트 작성 요청

#### ✅ 7. 작업 전 "백업/복구 가능 여부"를 확인한다

**확인 사항**:
- [ ] 최근 백업이 언제인가?
- [ ] 복구 요청 루트/권한/절차를 알고 있는가?
- [ ] 복구 절차 문서를 확보했는가?

**복구 절차 문서 위치**: [Neon 사용 가이드](./NEON_GUIDE.md) - Time Travel 섹션 참조

### 6.2 작업 후 체크리스트

#### ✅ 8. 작업 후에는 '검증 쿼리'를 실행한다

**예시: 제품 변경 후**

```sql
-- 1. 변경된 레코드 재조회
SELECT id, name, price, category, updated_at
FROM products
WHERE updated_at >= NOW() - INTERVAL '1 hour'
ORDER BY updated_at DESC;

-- 2. 주문/자산 화면이 정상인지 확인
SELECT COUNT(*) as recent_orders
FROM orders
WHERE created_at >= NOW() - INTERVAL '1 hour';
```

**확인 사항**:
- [ ] 변경된 레코드를 재조회하여 정상인가?
- [ ] 관련 기능(주문/자산)이 정상 작동하는가?

#### ✅ 9. 로그/지표 모니터링 (주 1회 이상)

**정기적으로 다음 지표를 확인하세요:**

**주문 시스템이 정상인지**:
```sql
-- orders 최근 생성 건수
SELECT COUNT(*) as recent_orders
FROM orders
WHERE created_at >= NOW() - INTERVAL '1 hour';

-- 주문 금액 합계
SELECT 
  COUNT(*) as total_orders,
  SUM(total_amount) as total_amount,
  SUM(copay_amount) as total_copay,
  SUM(claim_amount) as total_claim
FROM orders
WHERE created_at >= NOW() - INTERVAL '24 hours';
```

**자산 관리가 정상인지**:
```sql
-- assets 상태별 현황
SELECT 
  status,
  COUNT(*) as count
FROM assets
GROUP BY status;

-- 최근 상태 변경
SELECT COUNT(*) as recent_status_changes
FROM assets
WHERE updated_at >= NOW() - INTERVAL '1 hour';
```

**확인 사항**:
- [ ] `orders` 최근 생성 건수 (갑자기 0이 되면 주문 시스템 장애)
- [ ] `assets` 상태 분포 (비정상적인 상태 비율은 문제 신호)

#### ✅ 10. 권한 관련 변경은 절대 대시보드에서 즉흥적으로 하지 않는다

**금지 사항**:
- ❌ `users.role` 직접 변경 금지 (운영 프로세스/관리자 승인 절차 필요)
- ❌ `users.org_id` 직접 변경 금지 (멀티테넌시 격리 파괴)

**확인 사항**:
- [ ] `users.role`을 변경하려는가?
- [ ] `users.org_id`를 변경하려는가?
- [ ] 하나라도 해당되면 개발팀에 문의

---

## 7. 비상 상황 대응

### 7.1 데이터 오류 발견 시

**절차**:
1. **즉시 중단**: 대시보드에서 추가 수정 중단
2. **영향 범위 파악**: 어떤 데이터가 영향을 받았는지 확인
3. **백업 확인**: 최근 백업 데이터 확인
4. **복구 계획 수립**: 복구 방법 결정
5. **마이그레이션 작성**: 안전한 복구 스크립트 작성
6. **테스트**: 개발 환경에서 테스트
7. **복구 실행**: 프로덕션 환경에서 복구

### 7.2 데이터 복구

**원칙**: 백업에서 복구하거나, 마이그레이션 스크립트로 수정해야 합니다.

**절대 금지**:
- ❌ 대시보드에서 직접 데이터 수정으로 복구 시도
- ❌ 외래키 관계를 무시한 수정

**안전한 복구 방법**:
1. 백업에서 특정 테이블 복구
2. 마이그레이션 스크립트로 데이터 수정
3. 애플리케이션 API를 통한 수정

### 7.3 비상 연락처

**데이터베이스 문제 발생 시**:
- 개발팀에 즉시 연락
- 문제 상황 상세 설명
- 영향 범위 파악 요청

---

## 8. 참고 문서

- [데이터베이스 관리 원칙](./database-maintenance-guide.md) - 상세한 관리 원칙
- [데이터베이스 정규화 가이드](./database-normalization-guide.md) - 정규화 관련 상세 가이드
- [비개발자 데이터 관리 가이드](./비개발자-데이터관리-가이드.md) - 비개발자용 가이드
- [Neon 사용 가이드](./NEON_GUIDE.md) - Neon 데이터베이스 사용법

---

**문서 승인**

- 작성자: WeOps Team
- 최종 승인일: 2025-01-21

---

## 변경 이력

### v1.0 (2025-01-21)
- 초기 문서 작성
- 절대 수정 금지 테이블 리스트
- 테이블별 상세 설명
- 안전한 데이터 수정 방법
- 운영자 체크리스트
- 비상 상황 대응

