# 비개발자를 위한 데이터베이스 관리 가이드

**문서 버전**: 1.0  
**최종 수정일**: 2025-02-21  
**대상**: 비개발자 운영자  
**적용 범위**: LinkAble 데이터베이스 전체

---

## 📋 목차

1. [시작하기 전에](#1-시작하기-전에)
2. [절대 수정 금지 테이블](#2-절대-수정-금지-테이블)
3. [제한적 수정 가능 테이블](#3-제한적-수정-가능-테이블)
4. [운영자 체크리스트 10가지](#4-운영자-체크리스트-10가지)
5. [안전한 데이터 수정 방법](#5-안전한-데이터-수정-방법)
6. [로그 모니터링 포인트](#6-로그-모니터링-포인트)
7. [크롤링 데이터 관리](#7-크롤링-데이터-관리)
8. [비상 상황 대응](#8-비상-상황-대응)
9. [자주 묻는 질문 (FAQ)](#9-자주-묻는-질문-faq)

---

## 1. 시작하기 전에

### ⚠️ 이 가이드를 읽어야 하는 이유

데이터베이스는 서비스의 **핵심**입니다. 잘못 수정하면:
- 사용자가 로그인할 수 없게 됩니다
- 포인트 정산이 꼬여서 재무 문제가 발생합니다
- 추천 시스템이 작동하지 않습니다
- 법적 분쟁 시 증거 자료가 없어집니다

**이 가이드는 이런 사고를 방지하기 위한 것입니다.**

### 📌 핵심 원칙 4가지

1. **돈(포인트/전환)**: 절대 수정 금지
2. **시간(상담/메시지)**: 절대 수정 금지
3. **근거(AI분석/로그)**: 절대 수정 금지
4. **권한(users/role)**: 절대 수정 금지

### 🎯 이 가이드의 목적

- ✅ **안전하게** 데이터를 조회하고 수정하는 방법
- ✅ **사고를 방지**하는 체크리스트
- ✅ **문제 발생 시** 대응 방법
- ✅ **정기적으로 확인**해야 할 사항

---

## 2. 절대 수정 금지 테이블

### 🔴 절대 수정 금지 테이블 목록

아래 테이블들은 **Neon Console (SQL Editor)에서 절대 수정하면 안 됩니다.**

| 테이블명 | 왜 절대 금지인가 | 특히 건드리면 바로 사고 나는 필드 |
|---------|----------------|-------------------------------|
| `users` | 인증/권한/포인트의 기준. 잘못 수정하면 계정 연결/권한/정산 모두 깨짐 | `id`, `clerk_id`, `email`, `role`, `points` |
| `consultations` | 상담 세션(업무의 "헤더"). 하위 로그/분석/추천/전환이 모두 연결됨 | `id`, `user_id`, `status` |
| `chat_messages` | 상담 대화 원장(증거/품질/재현 데이터). 삭제/수정 시 분석/분쟁 대응 불가 | `id`, `consultation_id`, `sender`, `message_text` |
| `analysis_results` | AI 분석 결과 원장(재현/감사). 수정하면 추천 근거/통계 신뢰도 붕괴 | `id`, `consultation_id`, `icf_codes` |
| `recommendations` | 추천 결과 원장. 클릭/구매/평가/통계가 연결됨 | `id`, `consultation_id`, `product_id`, `rank` |
| `conversion_events` | 클릭/전환/구매 이벤트 로그(매출/성과 지표의 근거). 수정 금지 | `id`, `event_type`, `recommendation_id`, `product_id`, `purchase_amount` |
| `point_transactions` | 포인트 "원장". 여기 손대면 포인트 정산이 영구히 꼬임 | `id`, `user_id`, `points`, `transaction_type`, `reference_id` |
| `user_coupons` | 쿠폰 사용 이력/소진 증거. 수정하면 부정사용/정산 문제 | `id`, `user_id`, `coupon_id`, `used_at`, `expires_at` |
| `ippa_evaluations` | 효과성 평가 원장(모델 개선/리포트). 수정하면 KPI 붕괴 | `id`, `user_id`, `product_id`, `recommendation_id`, `activity_scores` |
| `consultation_feedback` | 상담 피드백 원장(품질/CS). 수정하면 지표 왜곡 | `id`, `consultation_id`, `user_id`, `accuracy_rating` |
| `icf_code_usage_logs` | ICF 코드 사용 로그(분석 근거/품질). 수정 금지 | `id`, `icf_code`, `consultation_id`, `source`, `context` |
| `icf_code_statistics` | ICF 통계(집계 결과). 직접 수정 금지(재계산으로만 갱신) | `icf_code` (PK), `total_usage_count`, `unique_consultations` |
| `icf_code_expansions` | 코드 확장 히스토리(자동화/품질). 수정 금지 | `id`, `icf_code`, `expanded_at`, `iso_hints` |
| `icf_auto_expand_config` | 자동 확장 설정(시스템 동작을 바꿈). 비개발자 수정 금지 | `enabled`, `threshold`, `updated_by` |
| `notifications` | 사용자 알림 원장(증빙/CS). 수정/삭제하면 분쟁 대응 불가 | `id`, `user_id`, `type`, `message`, `is_read` |

### ❌ 왜 위험한가?

#### 데이터 무결성 파괴
- 외래키 관계가 깨져서 조회 오류 발생
- 통계 집계가 잘못된 결과를 반환
- 정산 데이터가 맞지 않아 재무 문제 발생

#### 추적 불가능
- 로그/원장 데이터가 수정되면 감사(audit) 불가
- 분쟁 발생 시 증거 자료로 사용 불가
- 법적 문제 발생 시 대응 불가

#### 보안 취약
- `users` 테이블의 `role`을 잘못 수정하면 권한 우회 가능
- `clerk_id`를 수정하면 인증 시스템과 불일치 발생

### ✅ 허용되는 작업

- **읽기 전용 조회 (SELECT)**: 모든 테이블에서 데이터 조회는 허용됩니다
- **애플리케이션을 통한 수정**: 애플리케이션의 정상적인 기능을 통한 수정은 허용됩니다

---

## 3. 제한적 수정 가능 테이블

아래 2개 테이블은 운영자가 다루는 경우가 많아 **"제한적 허용"**으로 분류합니다.

### 3.1 products (상품 카탈로그)

**위험도**: 🟡 중간 (제한적 수정 가능)

#### ✅ 허용되는 필드 (필요 시 수정 가능)

- `description`: 상품 설명
- `image_url`: 상품 이미지 URL
- `purchase_link`: 구매 링크
- `price`: 가격
- `is_active`: 활성화 여부 (비활성화로 삭제 대체)
- `category`: 카테고리

#### ❌ 절대 금지 필드

- `id`: 상품 고유 식별자 (연결 무결성에 영향)
- `iso_code`: ISO 코드 (연결 무결성에 영향)
- 기타 연결 무결성에 영향을 주는 값

#### ⚠️ 주의사항

- ❌ **대량 일괄 수정 금지** (마이그레이션 스크립트 사용)
- ✅ **개별 상품 수정은 허용** (단, PK/FK 필드는 제외)
- ✅ **삭제 대신 `is_active = false` 사용**

#### 📝 안전한 수정 예시

```sql
-- ✅ 허용: 개별 상품 정보 수정
UPDATE products
SET description = '새로운 설명',
    price = 50000,
    is_active = true
WHERE id = '상품ID';

-- ❌ 금지: 대량 일괄 수정
UPDATE products SET price = price * 1.1;  -- 마이그레이션 스크립트로 처리해야 함

-- ❌ 금지: PK/FK 수정
UPDATE products SET id = '새ID';  -- 절대 금지
UPDATE products SET iso_code = '새코드';  -- 연결 무결성 파괴
```

### 3.2 coupons (쿠폰 정책)

**위험도**: 🟡 중간 (제한적 수정 가능)

#### ✅ 허용되는 필드

- `name`: 쿠폰 이름
- `description`: 쿠폰 설명
- `discount_value`: 할인 금액/비율
- `valid_from`: 유효 시작일
- `valid_until`: 유효 종료일
- `is_active`: 활성화 여부
- `usage_limit`: 사용 제한 횟수

#### ❌ 절대 금지 필드

- `id`: 쿠폰 고유 식별자
- `code`: 쿠폰 코드 (시스템에서 생성/관리)
- `usage_count`: 사용 횟수 (집계/운영 로직으로만 증가해야 함)

#### ⚠️ 주의사항

- ❌ `usage_count`는 직접 수정 금지 (시스템이 자동으로 증가)
- ✅ 쿠폰 정책 변경은 허용 (단, 이미 사용된 쿠폰은 변경 주의)
- ✅ 삭제 대신 `is_active = false` 사용

#### 📝 안전한 수정 예시

```sql
-- ✅ 허용: 쿠폰 정책 수정
UPDATE coupons
SET name = '새로운 쿠폰명',
    discount_value = 10000,
    valid_until = '2025-12-31',
    is_active = true
WHERE id = '쿠폰ID';

-- ❌ 금지: 사용 횟수 직접 수정
UPDATE coupons SET usage_count = 0;  -- 집계 로직으로만 증가해야 함

-- ❌ 금지: 쿠폰 코드 수정
UPDATE coupons SET code = 'NEWCODE';  -- 시스템에서 관리
```

---

## 4. 운영자 체크리스트 10가지

**작업 전/후 반드시 확인할 10개 항목**

대시보드에서 데이터를 수정하기 전에 반드시 아래 체크리스트를 확인하세요. 이 체크리스트를 따르면 비개발자 운영에서 사고 확률이 크게 줄어듭니다.

### 4.1 작업 전 체크리스트

#### ✅ 1. 작업 대상이 절대 수정 금지 테이블인지 먼저 확인한다

**금지 테이블 목록**:
- `users`, `consultations`, `chat_messages`, `analysis_results`, `recommendations`
- `conversion_events`, `point_transactions`, `user_coupons`
- `icf_*` (모든 ICF 관련 테이블)
- `notifications`, `ippa_activities`, `ippa_evaluations`, `consultation_feedback`

**확인 방법**:
- [ ] 작업 대상 테이블이 위 목록에 있는가?
- [ ] 있다면 즉시 중단하고 개발팀에 문의

#### ✅ 2. 수정 전, 대상 row를 먼저 SELECT로 '범위' 확인한다

**"몇 건이 바뀌는지"를 모르면 대량사고로 직행합니다.**

```sql
-- ✅ 반드시 먼저 실행: 영향받는 행 수 확인
SELECT COUNT(*) 
FROM products 
WHERE category = '보조기기'
AND is_active = true;

-- 확인 후에만 UPDATE 실행
UPDATE products 
SET price = price * 1.1
WHERE category = '보조기기'
AND is_active = true;
```

**확인 사항**:
- [ ] SELECT로 영향받는 행 수를 확인했는가?
- [ ] 예상보다 많은 행이 영향받는가? (있다면 중단)
- [ ] WHERE 조건이 정확한가?

#### ✅ 3. PK/FK는 절대 수정하지 않는다

**금지 필드**:
- `id`, `_id` (user_id, consultation_id, recommendation_id, product_id 등)

**확인 사항**:
- [ ] 수정하려는 필드가 PK(기본키)인가?
- [ ] 수정하려는 필드가 FK(외래키)인가?
- [ ] 하나라도 해당되면 수정 금지

#### ✅ 4. DELETE는 원칙적으로 금지 (특히 로그/원장성 테이블)

**삭제 대신 비활성화를 우선한다.**

**예시**:
- `products.is_active = false` (삭제 대신)
- `coupons.is_active = false` (삭제 대신)

**확인 사항**:
- [ ] DELETE를 실행하려는가?
- [ ] 로그/원장성 테이블인가?
- [ ] `is_active` 같은 비활성화 필드가 있는가?
- [ ] 있다면 DELETE 대신 비활성화 사용

#### ✅ 5. 결제/전환/포인트 값은 '수정'이 아니라 '정정 기록(추가 row)'로 처리한다

**특히 `point_transactions`, `conversion_events`는 덮어쓰기 금지.**

**올바른 방법**:
```sql
-- ✅ 올바른 방법: 정정 기록 추가
INSERT INTO point_transactions (user_id, points, transaction_type, reference_id, notes)
VALUES ('user_id', -100, 'correction', '원래거래ID', '오류 정정');

-- ❌ 잘못된 방법: 기존 거래 수정
UPDATE point_transactions SET points = -100 WHERE id = '거래ID';
```

**확인 사항**:
- [ ] `point_transactions` 또는 `conversion_events`를 수정하려는가?
- [ ] 수정 대신 정정 기록(INSERT)을 추가해야 하는가?

#### ✅ 6. 대시보드에서 대량 UPDATE/INSERT를 하지 않는다

**대량 작업은 반드시 개발자(또는 검증된 SQL 스크립트)로 진행.**

**기준**:
- 10건 이하: 대시보드에서 수정 가능 (단, PK/FK 제외)
- 10건 이상: 마이그레이션 스크립트 필수

**확인 사항**:
- [ ] 영향받는 행이 10건 이상인가?
- [ ] 있다면 개발팀에 마이그레이션 스크립트 작성 요청

#### ✅ 7. 작업 전 "백업/복구 가능 여부"를 확인한다

**Neon 자동 백업(Time Travel)이 있어도 "어떤 시점까지, 어떤 방식으로 복구 가능한지"를 운영자가 알고 있어야 합니다.**

**확인 사항**:
- [ ] 최근 백업이 언제인가?
- [ ] 복구 요청 루트/권한/절차를 알고 있는가?
- [ ] 복구 절차 문서를 확보했는가?

**복구 절차 문서 위치**: [Neon 사용 가이드](./NEON_GUIDE.md) - Time Travel 섹션 참조

### 4.2 작업 후 체크리스트

#### ✅ 8. 작업 후에는 '검증 쿼리'를 실행한다

**예시: 상품 변경 후**

```sql
-- 1. 변경된 레코드 재조회
SELECT id, name, price, is_active, updated_at
FROM products
WHERE updated_at >= NOW() - INTERVAL '1 hour'
ORDER BY updated_at DESC;

-- 2. 추천/전환 화면이 정상인지 확인
SELECT COUNT(*) as recent_recommendations
FROM recommendations
WHERE created_at >= NOW() - INTERVAL '1 hour';

SELECT COUNT(*) as recent_clicks
FROM conversion_events
WHERE event_type = 'recommendation_click'
AND created_at >= NOW() - INTERVAL '1 hour';
```

**확인 사항**:
- [ ] 변경된 레코드를 재조회하여 정상인가?
- [ ] 관련 기능(추천/전환)이 정상 작동하는가?
- [ ] 최근 1시간 추천/클릭이 들어오는가?

#### ✅ 9. 로그/지표 모니터링 (주 1회 이상)

**정기적으로 다음 지표를 확인하세요:**

**트래킹/매출 퍼널이 끊겼는지**:
```sql
-- conversion_events에서 최근 1시간 이벤트 건수
SELECT 
  event_type,
  COUNT(*) as count
FROM conversion_events
WHERE created_at >= NOW() - INTERVAL '1 hour'
GROUP BY event_type
ORDER BY count DESC;
```

**추천 시스템이 멈췄는지**:
```sql
-- recommendations 최근 생성 건수
SELECT COUNT(*) as recent_recommendations
FROM recommendations
WHERE created_at >= NOW() - INTERVAL '1 hour';

-- is_clicked 전환율
SELECT 
  COUNT(*) as total,
  COUNT(*) FILTER (WHERE is_clicked = true) as clicked,
  ROUND(100.0 * COUNT(*) FILTER (WHERE is_clicked = true) / COUNT(*), 2) as ctr
FROM recommendations
WHERE created_at >= NOW() - INTERVAL '24 hours';
```

**AI 분석이 실패하는지**:
```sql
-- analysis_results 최근 생성 건수
SELECT COUNT(*) as recent_analyses
FROM analysis_results
WHERE created_at >= NOW() - INTERVAL '1 hour';

-- 상담은 생기는데 분석 결과가 없으면 파이프라인 문제
SELECT 
  c.id as consultation_id,
  c.created_at,
  ar.id as analysis_id
FROM consultations c
LEFT JOIN analysis_results ar ON ar.consultation_id = c.id
WHERE c.created_at >= NOW() - INTERVAL '1 hour'
AND ar.id IS NULL;
```

**어뷰징/오류 조짐**:
```sql
-- point_transactions에서 특정 user_id가 비정상적으로 많은 적립
SELECT 
  user_id,
  COUNT(*) as transaction_count,
  SUM(points) as total_points
FROM point_transactions
WHERE created_at >= NOW() - INTERVAL '24 hours'
AND transaction_type = 'reward'
GROUP BY user_id
HAVING COUNT(*) > 100 OR SUM(points) > 100000
ORDER BY total_points DESC;
```

**확인 사항**:
- [ ] `conversion_events` 이벤트 타입별 건수 변화 (갑자기 0이 되면 트래킹 장애)
- [ ] `recommendations.is_clicked` 비율 (CTR 급락은 UX/링크 장애 신호)
- [ ] `point_transactions` 최근 증가량 (비정상 급증은 어뷰징 신호)

#### ✅ 10. 권한 관련 변경은 절대 대시보드에서 즉흥적으로 하지 않는다

**금지 사항**:
- ❌ `users.role` 직접 변경 금지 (운영 프로세스/관리자 승인 절차 필요)
- ❌ RLS/정책 변경은 개발자 검토 후 배포

**확인 사항**:
- [ ] `users.role`을 변경하려는가?
- [ ] RLS 정책을 변경하려는가?
- [ ] 하나라도 해당되면 개발팀에 문의

---

## 5. 안전한 데이터 수정 방법

### 5.1 애플리케이션을 통한 수정

**원칙**: 모든 데이터 수정은 애플리케이션의 API를 통해 수행해야 합니다.

**이유**:
- 비즈니스 로직 검증
- 권한 검증
- 로그 기록
- 데이터 무결성 보장

**예시**:
- ✅ 사용자 프로필 수정: `/api/users/profile` API 사용
- ✅ 상담 상태 변경: `/api/consultations/[id]/status` API 사용
- ❌ Neon Console에서 직접 `users` 테이블 수정

### 5.2 마이그레이션을 통한 수정

**원칙**: 대량 데이터 수정은 마이그레이션 스크립트로 수행해야 합니다.

**절차**:
1. 마이그레이션 스크립트 작성
2. 개발 환경에서 테스트
3. 코드 리뷰
4. 스테이징 환경에서 검증
5. 프로덕션 적용

**예시**:
```sql
-- ✅ 올바른 방법: 마이그레이션 스크립트
-- src/db/migrations/YYYYMMDDHHMMSS_fix_user_points.sql
UPDATE point_transactions
SET points = points * 1.1
WHERE transaction_type = 'reward'
AND created_at >= '2025-01-01';

-- ❌ 잘못된 방법: 대시보드에서 직접 수정
```

### 5.3 읽기 전용 조회

**원칙**: 대시보드에서 데이터 조회는 허용됩니다.

**허용되는 작업**:
- ✅ SELECT 쿼리 실행
- ✅ 통계 조회
- ✅ 데이터 검증

**주의사항**:
- 개인정보가 포함된 데이터는 조회 시 주의
- 대량 조회는 성능에 영향을 줄 수 있음

---

## 6. 로그 모니터링 포인트

정기적으로 다음 지표들을 모니터링하여 시스템 건강도를 확인하세요.

### 6.1 트래킹/매출 퍼널 모니터링

**목적**: 트래킹/매출 퍼널이 끊겼는지 확인

**확인 쿼리**:
```sql
-- conversion_events에서 최근 1시간 이벤트 타입별 건수
SELECT 
  event_type,
  COUNT(*) as count,
  COUNT(DISTINCT user_id) as unique_users
FROM conversion_events
WHERE created_at >= NOW() - INTERVAL '1 hour'
GROUP BY event_type
ORDER BY count DESC;
```

**주요 이벤트 타입**:
- `recommendation_click`: 추천 클릭
- `purchase_link_click`: 구매 링크 클릭
- `purchase_completed`: 구매 완료

**경고 신호**:
- ⚠️ 최근 1시간 동안 이벤트가 0건이면 트래킹 장애 가능
- ⚠️ 특정 이벤트 타입만 0이면 해당 기능 장애 가능

### 6.2 추천 시스템 모니터링

**목적**: 추천 시스템이 멈췄는지 확인

**확인 쿼리**:
```sql
-- 1. recommendations 최근 생성 건수
SELECT COUNT(*) as recent_recommendations
FROM recommendations
WHERE created_at >= NOW() - INTERVAL '1 hour';

-- 2. is_clicked 전환율 (CTR)
SELECT 
  COUNT(*) as total_recommendations,
  COUNT(*) FILTER (WHERE is_clicked = true) as clicked_recommendations,
  ROUND(100.0 * COUNT(*) FILTER (WHERE is_clicked = true) / COUNT(*), 2) as click_through_rate
FROM recommendations
WHERE created_at >= NOW() - INTERVAL '24 hours';
```

**경고 신호**:
- ⚠️ 최근 1시간 동안 추천이 0건이면 추천 시스템 장애
- ⚠️ CTR이 급락하면 UX/링크 장애 가능

### 6.3 AI 분석 파이프라인 모니터링

**목적**: AI 분석이 실패하는지 확인

**확인 쿼리**:
```sql
-- 1. analysis_results 최근 생성 건수
SELECT COUNT(*) as recent_analyses
FROM analysis_results
WHERE created_at >= NOW() - INTERVAL '1 hour';

-- 2. 상담은 생기는데 분석 결과가 없으면 파이프라인 문제
SELECT 
  c.id as consultation_id,
  c.created_at as consultation_created,
  ar.id as analysis_id,
  ar.created_at as analysis_created
FROM consultations c
LEFT JOIN analysis_results ar ON ar.consultation_id = c.id
WHERE c.created_at >= NOW() - INTERVAL '1 hour'
AND ar.id IS NULL
ORDER BY c.created_at DESC;
```

**경고 신호**:
- ⚠️ 최근 1시간 동안 분석 결과가 0건이면 AI 파이프라인 장애
- ⚠️ 상담은 생기는데 분석 결과가 없으면 파이프라인 문제

### 6.4 어뷰징/오류 탐지

**목적**: 비정상적인 활동 탐지

**확인 쿼리**:
```sql
-- point_transactions에서 특정 user_id가 비정상적으로 많은 적립
SELECT 
  u.email,
  pt.user_id,
  COUNT(*) as transaction_count,
  SUM(pt.points) as total_points,
  MAX(pt.created_at) as last_transaction
FROM point_transactions pt
JOIN users u ON u.id = pt.user_id
WHERE pt.created_at >= NOW() - INTERVAL '24 hours'
AND pt.transaction_type = 'reward'
GROUP BY u.email, pt.user_id
HAVING COUNT(*) > 100 OR SUM(pt.points) > 100000
ORDER BY total_points DESC
LIMIT 20;
```

**경고 신호**:
- ⚠️ 특정 사용자가 24시간 내 100건 이상 거래 또는 100,000 포인트 이상 적립
- ⚠️ 비정상적인 패턴 발견 시 즉시 조사 필요

### 6.5 모니터링 주기

**권장 주기**:
- **일 1회**: 트래킹/매출 퍼널, 추천 시스템
- **주 1회**: AI 분석 파이프라인, 어뷰징 탐지
- **월 1회**: 전체 시스템 종합 점검

**자동화 권장**:
- 위 쿼리들을 스케줄러로 실행하여 대시보드에 표시
- 경고 신호 발생 시 알림 설정

---

## 7. 크롤링 데이터 관리

### 7.1 크롤링 데이터의 3단계 계층

크롤링이 들어오면 **"정규화 계층"을 3단으로 나누는 게 실무 표준**입니다.

**A. Raw(원문 보관) 계층 — "증거/재현/디버깅"**
- 크롤링한 HTML/JSON 원문을 그대로 저장
- 파싱 로직이 바뀌어도 재파싱 가능
- 장애 분석/법적 이슈/원천 사이트 변경 대응에 유리

**B. Listing(원천 상품) 계층 — "소스별 상품 단위"**
- 쿠팡/스마트스토어/자사몰 등 `source + external_id` 기준으로 한 건의 원천상품
- 가격/재고/배송/리뷰/랭킹 같은 "자주 변하는 값"은 별도 스냅샷 테이블로 분리(정규화)

**C. Canonical(정제 상품) 계층 — "서비스가 추천하는 표준 상품"**
- 지금 ERD의 `products`가 여기에 해당
- 여러 source listing을 하나의 canonical product에 매핑(중복 제거, 통합)

**핵심 포인트**:
> 크롤링 시스템은 "원천(source)"이 바뀌고 "가격/재고"가 계속 변합니다.  
> 그래서 `products` 한 테이블에 다 때려 넣으면 6개월 후에 무조건 운영이 지옥이 됩니다.

### 7.2 크롤링 관련 주요 테이블

**1. `crawl_sources`**: 소스/채널 정의
- 쿠팡, 스마트스토어, 자사몰 등 소스 관리
- 각 소스별 크롤링 정책(레이트리밋/헤더/파서) 관리

**2. `crawl_jobs`, `crawl_requests`**: 크롤링 작업 추적
- 크롤링은 100% 장애가 납니다(차단/타임아웃/파서 깨짐/구조 변경)
- "언제, 무엇을, 왜 실패했는지"를 DB에 남겨야 재시도/복구가 가능

**3. `raw_documents`**: 원문 저장
- 파싱 결과만 저장하면 "파서 버그"가 났을 때 재현이 안 됨
- 원문은 용량이 매우 큼 → 파티셔닝/TTL(보관기간)/압축 정책 필요

**4. `product_listings`**: 원천 상품
- `products` (정제)와 분리해야 함
- listing은 "원천 소스의 상품 1개"이며, `source_id + external_id`가 유일 키

**5. `listing_price_snapshots`**: 가격/재고 변동값
- listing row를 업데이트로 덮어쓰지 말고, 스냅샷(시간축) 테이블로 분리
- 이렇게 해야 "가격변동", "재고변동", "추천 후 구매율" 분석이 가능

**6. `product_listing_map`**: 중복 제거/매핑
- listing(원천) ↔ product(정제) 관계는 거의 항상 N:1
- 여러 listing이 하나의 canonical product로 합쳐짐

### 7.3 크롤링 데이터 관리 체크리스트

**1) 데이터 폭증 테이블부터 파티션/보관정책을 먼저 정해라**
- `listing_price_snapshots`, `raw_documents`, `crawl_requests`
- "무한정 쌓아두기"는 100% 장애로 돌아옵니다(백업, vacuum, 인덱스, 비용).

**2) 중복 방지 키(UNIQUE) 없으면 크롤링은 망한다**
- listing은 `source_id + external_id` 유니크가 사실상 생명줄
- price snapshot은 중복 방지 정책을 별도로 설계(동일 시각 중복 삽입 방지)

**3) 원문 저장은 "DB vs 스토리지"를 조기에 결정**
- **DB 저장**: 개발/디버깅 쉬움, 비용/용량 위험
- **스토리지 저장**: 운영에 유리, 다만 조회/권한/정합성 설계 필요
- **실무에서는 원문은 스토리지 + DB에 해시/경로만이 오래갑니다.**

**4) 추천/구매/전환 "정답 테이블"을 하나로 고정**
- `recommendations`에 구매여부를 두면 편하지만, 이벤트 로그와 충돌나기 쉬움
- 정답은 `conversion_events` (또는 `purchases`)로 고정하고 나머지는 파생값으로 운용 추천

**5) 장애/차단/재시도는 애초에 데이터 모델에 넣어라**
- `attempt_count`, `next_retry_at`, `error_*` 없이 운영하면 "왜 누락됐지?"를 영원히 못 잡습니다.

---

## 8. 비상 상황 대응

### 8.1 데이터 오류 발견 시

**절차**:
1. **즉시 중단**: 대시보드에서 추가 수정 중단
2. **영향 범위 파악**: 어떤 데이터가 영향을 받았는지 확인
3. **백업 확인**: 최근 백업 데이터 확인
4. **복구 계획 수립**: 복구 방법 결정
5. **마이그레이션 작성**: 안전한 복구 스크립트 작성
6. **테스트**: 개발 환경에서 테스트
7. **복구 실행**: 프로덕션 환경에서 복구

### 8.2 데이터 복구

**원칙**: 백업에서 복구하거나, 마이그레이션 스크립트로 수정해야 합니다.

**절대 금지**:
- ❌ 대시보드에서 직접 데이터 수정으로 복구 시도
- ❌ 외래키 관계를 무시한 수정

**안전한 복구 방법**:
1. 백업에서 특정 테이블 복구
2. 마이그레이션 스크립트로 데이터 수정
3. 애플리케이션 API를 통한 수정

### 8.3 비상 연락처

**데이터베이스 문제 발생 시**:
- 개발팀에 즉시 연락
- 문제 상황 상세 설명
- 영향 범위 파악 요청

---

## 9. 자주 묻는 질문 (FAQ)

### Q1. 테이블을 수정해도 되는지 모르겠어요.

**A**: 절대 수정 금지 테이블 목록을 먼저 확인하세요. 목록에 있으면 절대 수정하지 마세요. 목록에 없어도 PK/FK 필드는 수정 금지입니다.

### Q2. 대량으로 데이터를 수정해야 하는데 어떻게 해야 하나요?

**A**: 10건 이상이면 개발팀에 마이그레이션 스크립트 작성 요청을 하세요. 10건 이하라도 PK/FK 필드는 수정 금지입니다.

### Q3. 데이터를 삭제해야 하는데 어떻게 해야 하나요?

**A**: DELETE는 원칙적으로 금지입니다. 대신 `is_active = false` 같은 비활성화 필드를 사용하세요.

### Q4. 포인트나 구매 금액을 수정해야 하는데 어떻게 해야 하나요?

**A**: 기존 데이터를 수정하지 마세요. 대신 정정 기록(INSERT)을 추가하세요. 예: `point_transactions`에 정정 거래를 추가.

### Q5. 작업 후 어떻게 확인하나요?

**A**: 작업 후 검증 쿼리를 실행하여 변경된 레코드를 재조회하고, 관련 기능이 정상 작동하는지 확인하세요.

### Q6. 정기적으로 확인해야 할 사항이 있나요?

**A**: 주 1회 이상 다음을 확인하세요:
- 트래킹/매출 퍼널 (conversion_events)
- 추천 시스템 (recommendations)
- AI 분석 파이프라인 (analysis_results)
- 어뷰징 탐지 (point_transactions)

### Q7. 크롤링 데이터는 어떻게 관리하나요?

**A**: 크롤링 데이터는 3단계 계층(Raw/Listing/Canonical)으로 관리합니다. 특히 가격/재고 같은 변동값은 스냅샷 테이블로 분리하여 시간축 추적이 가능하도록 합니다.

### Q8. 문제가 발생했을 때 어떻게 해야 하나요?

**A**: 즉시 수정을 중단하고, 개발팀에 연락하세요. 백업 확인 및 복구 계획 수립이 필요합니다.

---

## 10. 참고 자료

- [데이터베이스 관리 원칙](./database-maintenance-guide.md) - 상세한 관리 원칙
- [데이터베이스 정규화 가이드](./database-normalization-guide.md) - 정규화 관련 상세 가이드
- [데이터베이스 백업 가이드](./database-backup-guide.md) - 백업 및 복구 절차

---

## 문서 정보

**작성자**: Linkable  
**검토자**: [이름]  
**승인자**: [이름]  
**최종 승인일**: 2025-02-21

**변경 이력**:
- v1.0 (2025-02-21): 초기 문서 작성

---

**⚠️ 중요**: 이 가이드는 비개발자 운영자를 위한 것입니다. 기술적인 세부사항이 필요하면 개발팀에 문의하세요.

